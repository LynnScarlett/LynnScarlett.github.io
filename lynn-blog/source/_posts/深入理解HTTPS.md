---
title: 深入理解HTTPS
date: 2019-03-08 14:09:26
categories:
  - 前端基础
tags:
  - HTTP
  - HTTPS
---

# 深入理解 HTTPS

在春天的面试过程中，HTTP/HTTPS 作为网络基础的一部分，几乎个面试官都有问到。本文将从网络协议开始，分析 HTTPS 如何做到相对安全的网络传输。

## TL;DR

- 使用数字签名、数字证书建立 SSL 连接
- 使用连接时的随机数生成对称密钥加密报文

## HTTP 报文

未经过加密的 HTTP 报文在传输时，主要面临三个问题

1. 明文传输导致敏感信息泄露
2. 易遭受 MitM 攻击
3. 易遭篡改

而 HTTPS 在 HTTP 的基础之上，在应用层下的表示层进行 SSL 加/解密，使得明文信息受到保护。

## 加密方式

常用的加密方式可以分成两种

- 对称密钥加密
- 非对称密钥加密（公开密钥加密）

对称密钥加密在加密和解密时使用相同的密钥，或是使用两个可以简单地相互推算的密钥。优点是加解密速度快，缺点是双方需要获取相同秘钥。

非对称密钥需要两个密钥，一个是公开密钥，另一个是私有密钥；一个用作加密，另一个则用作解密。使用其中一个密钥把明文加密后所得的密文，只能用相对应的另一个密钥才能解密得到原本的明文；甚至连最初用来加密的密钥也不能用作解密。而且知道了其中一个，并不能凭此计算出另外一个；因此其中一个可以公开，称为公钥，任意向外发布；不公开的密钥为私钥，必须由用户自行严格秘密保管，绝不透过任何途径向任何人提供，也不会透露给被信任的要通信的另一方。优点是较为安全，只要私钥不泄露，传输就能保证单向的安全；缺点是加/解密速度较慢。

所以，HTTPS 的传输过程可以分成两步：1. 使用非对称密钥建立连接，交换生成对称密钥的必要信息；2. 使用生成的对称密钥加密 HTTP 报文。

## 数字证书与数字签名

数字证书是由权威公正的第三方机构（CA）发放的身份凭证。

CA 机构内部有单独的一对非对称密钥，C 和 C'。私钥 C'保存在 CA 机构的服务器中，公钥则存在于每个浏览器的内部。

假设服务器 S 对应的域名为 S.com，S 首先在服务器内生成一对`非对称密钥`S 和 S'，妥善保存`私钥`，将`公钥`和其他必要的信息发送给 CA 进行认证。CA 核实确认 S 提交的信息无误后，把所有信息进行一次哈希运算，得到近乎唯一的字符串。再用 CA 的`私钥C'`加密该字符串，得到的就是数字证书的`数字签名`，把以上信息合起来，就是 S 服务器的`数字证书`。

## 建立连接

### Client hello & Server hello

当客户端 B 发起 SSL 握手时，向服务器 S 请求证书并发送随机数，S 返回对应域名的数字证书、随机数和加密方式等等。

### Certificate Request & Certificate Verify

客户端获取到证书，用浏览器内置的 CA 公钥 C，解密该证书的`数字签名`部分，同时对数字证书的其他部分做一次哈希运算，如果得到相同的字符串，则证明该证书没有篡改过，也就证明了该服务器的公钥是 S 的公钥。

### Client Key Exchange

客户端确认了数字证书的正确性之后，会用第一次握手获得的`公钥S`，加密一个随机数，发送给服务器。

这一过程是**单向安全**的，因为通过公钥 S 加密的数据，只有私钥 S'才能够解密。而私钥只保存在服务器中。这也就意味着无论是采用中间人攻击还是篡改，都无法威胁到这一次传输的正确性。

## 对称加密

三次握手结束之后，连接双方分别采用商定的算法和三个随机数算出对称密钥`K`。此时的对称密钥是安全的，因为生成所用的随机数其中一个是绝对安全的，同时对称密钥也没有在网络上传输。

此后 SSL 链接都经过对称密钥加密，防止了中间人攻击和篡改。

## 参考链接

1. [HTTP 权威指南](https://www.amazon.cn/dp/B008XFDQ14/)
2. [HTTPS -- CSDN](https://blog.csdn.net/yuanmengong886/article/details/73557464)
3. [SSL 握手过程 --简书](https://www.jianshu.com/p/7158568e4867)
4. [对称密钥 -- Wikipedia](https://zh.wikipedia.org/wiki/%E5%B0%8D%E7%A8%B1%E5%AF%86%E9%91%B0%E5%8A%A0%E5%AF%86)
5. [非对称密钥 --Wikipedia](https://zh.wikipedia.org/wiki/%E5%85%AC%E5%BC%80%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86)
